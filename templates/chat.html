<!DOCTYPE html>
<html>
<head>
    <title>Medical Chatbot</title>

    <!-- Bootstrap & Icons -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">

    <!-- jQuery -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- App CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">

                <!-- Header -->
                <div class="card-header msg_head">
                    <div class="d-flex align-items-center">
                        <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png"
                             class="rounded-circle user_img">
                        <div class="user_info ml-3">
                            <span>Medical Chatbot</span>
                            <p>Ask me anything</p>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messageFormeight" class="card-body msg_card_body"></div>

                <!-- Image preview -->
                <div id="imagePreviewContainer" class="p-2" style="display:none;">
                    <img id="imagePreview" style="max-width:120px;border-radius:10px;">
                    <button id="removeImage" class="btn btn-sm btn-danger ml-2">Remove</button>
                </div>

                <!-- Input -->
                <div class="card-footer">
                    <form id="messageArea" class="input-group">

                        <input type="file" id="imageInput" accept="image/*" hidden>

                        <input type="text" id="text"
                               placeholder="Type your message or use the micâ€¦"
                               class="form-control type_msg">

                        <div class="input-group-append">

                            <!-- Mic -->
                            <button type="button" id="micBtn" class="input-group-text">
                                <i class="fas fa-microphone"></i>
                            </button>

                            <!-- Camera -->
                            <button type="button" id="imageBtn" class="input-group-text">
                                <i class="fas fa-camera"></i>
                            </button>

                            <!-- Send -->
                            <button type="submit" class="input-group-text send_btn">
                                <i class="fas fa-location-arrow"></i>
                            </button>

                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
/* ================= Formatting ================= */

function formatBotMessage(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/^- /gm, "â€¢ ")
        .replace(/\n{3,}/g, "\n\n")
        .replace(/\n/g, "<br>");
}

/* ================= Helpers ================= */

function scrollDown() {
    $("#messageFormeight").scrollTop($("#messageFormeight")[0].scrollHeight);
}

function showLoading(label="Thinkingâ€¦") {
    $("#messageFormeight").append(`
        <div class="d-flex align-items-start justify-content-start mb-2" id="loadingBubble">
            <div class="msg_cotainer">
                <i class="fas fa-spinner fa-spin"></i> ${label}
            </div>
        </div>
    `);
    scrollDown();
}

function hideLoading() {
    $("#loadingBubble").remove();
}

/* ================= State ================= */
let selectedImage = null;
let mediaRecorder = null;
let audioChunks = [];

/* ================= Ready ================= */

$(document).ready(function () {

    /* ---------- Image ---------- */
    $("#imageBtn").click(() => $("#imageInput").click());

    $("#imageInput").on("change", function (e) {
        selectedImage = e.target.files[0];
        const reader = new FileReader();
        reader.onload = e => {
            $("#imagePreview").attr("src", e.target.result);
            $("#imagePreviewContainer").show();
        };
        reader.readAsDataURL(selectedImage);
    });

    $("#removeImage").click(() => clearImage());

    function clearImage() {
        selectedImage = null;
        $("#imagePreviewContainer").hide();
        $("#imageInput").val("");
    }

    /* ---------- Audio ---------- */
    $("#micBtn").click(async function () {
        if (!mediaRecorder) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;

            mediaRecorder.start();
            $("#micBtn i").removeClass("fa-microphone").addClass("fa-stop");
        } else {
            mediaRecorder.stop();
            mediaRecorder = null;
            $("#micBtn i").removeClass("fa-stop").addClass("fa-microphone");
        }
    });

    function sendAudio() {
        showLoading("Transcribingâ€¦");

        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const fd = new FormData();
        fd.append("audio", blob);

        fetch("/transcribe_audio", { method: "POST", body: fd })
            .then(r => r.json())
            .then(d => {
                hideLoading();
                if (d.text) $("#text").val(d.text);
            })
            .catch(hideLoading);
    }

    /* ---------- Send Message ---------- */
    $("#messageArea").submit(function (e) {
        e.preventDefault();

        const text = $("#text").val().trim();
        $("#text").val("");

        if (!text && !selectedImage) return;

        $("#messageFormeight").append(`
            <div class="d-flex align-items-start justify-content-end mb-2">
                <div class="msg_cotainer_send">
                    ${text || "[Image uploaded]"}
                </div>
            </div>
        `);
        scrollDown();

        showLoading();

        if (selectedImage) {
            const fd = new FormData();
            fd.append("image", selectedImage);
            fd.append("question", text);

            clearImage(); // ðŸ”¥ immediately remove preview

            fetch("/upload_image", { method: "POST", body: fd })
                .then(r => r.text())
                .then(handleBotResponse);
            return;
        }

        fetch("/get", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "msg=" + encodeURIComponent(text)
        })
        .then(r => r.text())
        .then(handleBotResponse);
    });
});

/* ================= Bot Handling ================= */

function handleBotResponse(text) {
    hideLoading();

    const EMERGENCY_TAG = "[[EMERGENCY]]";
    const isEmergency = text.startsWith(EMERGENCY_TAG);
    const cleanText = isEmergency ? text.replace(EMERGENCY_TAG, "").trim() : text;

    $("#messageFormeight").append(`
        <div class="d-flex align-items-start justify-content-start mb-2">
            <div class="msg_cotainer">
                ${formatBotMessage(cleanText)}
            </div>
        </div>
    `);
    scrollDown();

    if (isEmergency) requestLocation();
}

/* ================= Location ================= */

function requestLocation() {
    if (!navigator.geolocation) return;

    showLoading("Finding nearby hospitalsâ€¦");

    navigator.geolocation.getCurrentPosition(pos => {
        const fd = new URLSearchParams();
        fd.append("lat", pos.coords.latitude);
        fd.append("lng", pos.coords.longitude);

        fetch("/location", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: fd.toString()
        })
        .then(r => r.text())
        .then(text => {
            hideLoading();
            $("#messageFormeight").append(`
                <div class="d-flex align-items-start justify-content-start">

                    <div class="msg_cotainer">
                        ${formatBotMessage(text)}
                    </div>
                </div>
            `);
            scrollDown();
        });
    });
}
</script>
</body>
</html>
