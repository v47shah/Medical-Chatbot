<!DOCTYPE html>
<html>
<head>
    <title>Medical Chatbot</title>

    <!-- Bootstrap & Icons -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">

    <!-- jQuery -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Your CSS -->
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static', filename='style.css') }}"/>
</head>

<body>
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">

                <!-- Header -->
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="img_cont">
                            <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png"
                                 class="rounded-circle user_img">
                            <span class="online_icon"></span>
                        </div>
                        <div class="user_info">
                            <span>Medical Chatbot</span>
                            <p>Ask me anything!</p>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messageFormeight" class="card-body msg_card_body"></div>

                <!-- Image preview -->
                <div id="imagePreviewContainer" class="p-2" style="display:none;">
                    <img id="imagePreview"
                         style="max-width:150px; border-radius:10px;" />
                    <button id="removeImage"
                            class="btn btn-sm btn-danger ml-2">
                        Remove
                    </button>
                </div>

                <!-- Input -->
                <div class="card-footer">
                    <form id="messageArea" class="input-group">

                        <!-- Hidden image input -->
                        <input type="file"
                               id="imageInput"
                               accept="image/*"
                               hidden />

                        <input type="text"
                               id="text"
                               placeholder="Type your message..."
                               autocomplete="off"
                               class="form-control type_msg"/>

                        <div class="input-group-append">

                            <!-- Camera button -->
                            <button type="button"
                                    id="imageBtn"
                                    class="input-group-text">
                                <i class="fas fa-camera"></i>
                            </button>

                            <!-- Send button -->
                            <button type="submit"
                                    id="send"
                                    class="input-group-text send_btn">
                                <i class="fas fa-location-arrow"></i>
                            </button>

                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    function formatBotMessage(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/^- /gm, "‚Ä¢ ")
            .replace(/\n/g, "<br>");
    }

    // üîÑ Loading indicator
    function showLoading() {
        const loadingHtml =
            '<div class="d-flex justify-content-start mb-4" id="loadingBubble">' +
                '<div class="img_cont_msg">' +
                    '<img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" ' +
                         'class="rounded-circle user_img_msg">' +
                '</div>' +
                '<div class="msg_cotainer">' +
                    '<i class="fas fa-spinner fa-spin"></i> Thinking...' +
                '</div>' +
            '</div>';

        $("#messageFormeight").append(loadingHtml);
        $("#messageFormeight").scrollTop(
            $("#messageFormeight")[0].scrollHeight
        );
    }

    function hideLoading() {
        $("#loadingBubble").remove();
    }

    let selectedImage = null;

    $(document).ready(function () {

        // üì∑ Open image picker
        $("#imageBtn").on("click", function () {
            $("#imageInput").click();
        });

        // üñºÔ∏è Preview image
        $("#imageInput").on("change", function (e) {
            selectedImage = e.target.files[0];
            if (!selectedImage) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                $("#imagePreview").attr("src", e.target.result);
                $("#imagePreviewContainer").show();
            };
            reader.readAsDataURL(selectedImage);
        });

        // ‚ùå Remove image
        $("#removeImage").on("click", function () {
            selectedImage = null;
            $("#imageInput").val("");
            $("#imagePreviewContainer").hide();
        });

        $("#messageArea").on("submit", function (event) {
            event.preventDefault();

            const rawText = $("#text").val().trim();
            $("#text").val("");

            if (!rawText && !selectedImage) return;

            const date = new Date();
            const str_time =
                date.getHours() + ":" +
                String(date.getMinutes()).padStart(2, "0");

            // User message bubble
            const userHtml =
                '<div class="d-flex justify-content-end mb-4">' +
                    '<div class="msg_cotainer_send">' +
                        (rawText || "[Image uploaded]") +
                        '<span class="msg_time_send">' + str_time + '</span>' +
                    '</div>' +
                    '<div class="img_cont_msg">' +
                        '<img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" ' +
                             'class="rounded-circle user_img_msg">' +
                    '</div>' +
                '</div>';

            $("#messageFormeight").append(userHtml);

            // üîÑ Show loading
            showLoading();

            // üß† IMAGE + TEXT
            if (selectedImage) {
                const formData = new FormData();
                formData.append("image", selectedImage);
                formData.append("question", rawText);

                $.ajax({
                    url: "/upload_image",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                }).done(function (data) {
                    hideLoading();
                    appendBotMessage(data, str_time);
                });

                selectedImage = null;
                $("#imageInput").val("");
                $("#imagePreviewContainer").hide();
                return;
            }

            // üß† TEXT ONLY
            $.ajax({
                data: { msg: rawText },
                type: "POST",
                url: "/get",
            }).done(function (data) {
                hideLoading();
                appendBotMessage(data, str_time);
            });
        });

        function appendBotMessage(data, time) {
            const formatted = formatBotMessage(data);

            const botHtml =
                '<div class="d-flex justify-content-start mb-4">' +
                    '<div class="img_cont_msg">' +
                        '<img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" ' +
                             'class="rounded-circle user_img_msg">' +
                    '</div>' +
                    '<div class="msg_cotainer">' +
                        formatted +
                        '<span class="msg_time">' + time + '</span>' +
                    '</div>' +
                '</div>';

            $("#messageFormeight").append(botHtml);
            $("#messageFormeight").scrollTop(
                $("#messageFormeight")[0].scrollHeight
            );
        }
    });
</script>

</body>
</html>
